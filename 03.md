第三章 能救命的编码花絮和风格
============
作者 David "Rez" Graham


2005年12月5日，我走进旧金山市区一桩陈旧办公楼的5楼。离电梯不远有条门，门上贴着一个纸条，写着“Super-Ego Games”。整个办公室不到12个人，几乎都是程序员。这是我作为职业视频游戏程序员的第一天。当时我已经自己开发了9年的游戏，因此我觉得我是有优势的。我完全错了。把3维模型渲染到屏幕上、播放音效、读取输入设备、实现游戏性等等都是游戏开发的重要组成部分，但在这些之外还有一个非常重要的部分：架构。

架构指的是你的游戏代码的结构，如何把所有的小块拼接到一起。一个架构良好的引擎可以被反复使用来制作与最初的游戏类似的游戏。每个游戏都会遇到类似的问题，比如从硬盘加载资源以及高效地渲染物体到屏幕上。这些问题通常需要根据你要制作的游戏的类型进行调整。例如，从场景中高效地挑选出需要渲染的物体常常需要不同的技术，它依赖于你的场景几何体是如何排布的。室内场景为主的地图鱼与室外场景为主的场景的渲染会使用不同的技术。大多数时候，不同的引擎都会根据特定类型的游戏而进行结构的调整。如果你生于80年代或90年代，你可能会记得古老的冒险游戏Sierra，它最先开始使用一种“指向-点击”的界面。同一款引擎还被用来制作几十款类似的游戏。工程师们不需要关心物体是如何渲染的或者如何显示一个文本框，他们只是利用引擎提供的工具来完成工作。

##通用编码风格
如果你走进一个坐满程序员的房间，询问他们如何命名变量或者如何放置括号，你会发现这场讨论会迅速变成一场全面战争。 每个程序员对编码风格都有自己的意见。这是合理的，因为我们每天大部分的时间都盯着代码。最终，你看到的各种各样的风格其实差异并不大。我曾经在自己的项目中使用过一种对我个人非常合适的风格。你可能不喜欢我命名变量的方式，或者用骆驼命名法来命名函数和类，这都没关系。你因该使用适合你的方法。然而，我还是想分享一些我曾经遇到过的麻烦。
###括号
我对括号态度强硬。我在多个场景中修改过由于括号放置问题引起的逻辑问题。我曾经遇到过3中放置括号的风格。第一种是每个括号单独占一行：


    void FindObject( unsigned int id, str::list& found)
    {
    	for (int i = 0; i < m_max; ++i)
    	{
    		if(m_map[i].id == id)
    		{
    			found.push_back(m_map[i]);
    			GCC_LOG("Objects", "Found");
    		}
    		else
    		{
    			GCC_LOG("Objects", "Not Found");
    		}
    	}
		GCC_LOG("Objects", "Not Found");
    }


第二种称为K&F方法：

    void FindObject( unsigned int id, str::list& found){
    	for (int i = 0; i < m_max; ++i){
    		if(m_map[i].id == id){
    			found.push_back(m_map[i]);
    			GCC_LOG("Objects", "Found");
    		}
    		else{
    			GCC_LOG("Objects", "Not Found");
    		}
    	}
		GCC_LOG("Objects", "Not Found");
    }

第三种就是在任何有意义的地方随意放置：

	void FindObject( unsigned int id, str::list& found)
	{
    	for (int i = 0; i < m_max; ++i)
			{
    		if(m_map[i].id == id)
			{
    		found.push_back(m_map[i]);
    		GCC_LOG("Objects", "Found");
    		}
    			else{GCC_LOG("Objects", "Not Found");
    		}
    	}
		GCC_LOG("Objects", "Not Found");
    }

哪一种最容易阅读？在我看了，第一种远比其他两种更好读。我认识一些程序员更喜欢第二种，他们觉得这样的风格更省空间而且代码更紧凑，而且可读性上也不差。我完全不同意这种看法。因为我好几次遇到过由于K&R方法造成的不对齐而引起的bug。相反，我还从没遇到过第一种方法引发的bug。虽然在一些公司里第二种方法也是合法的风格。最重要的是绝不要使用第三种方法。随意地放置括号和缩进会产生难以阅读的代码。
> 5000行恐怖的代码
> 
> 在开发Barbie Diaries时，针对相机代码的架构有许多的抱怨。代码的原作者已经离开了公司，因此在游戏发行之后，在开始制作下一款游戏之前，我被要求来重构整个相机系统。当我打开SeCameraMgr.cpp文件时我被吓坏了，我发现整个相机系统是一堆相互嵌套的switch/case语句，而且缩进和括号匹配也是相当随意。在重构之前，我花了大约一个小时调整括号匹配才能阅读代码。我花费了两个星期才重构出一个可用并可扩展的相机系统


###一致性
下面这些函数名哪个最好？

    Action* FindBestAction(void);
    Action* findBestAction (void);
    Action* find_best_action( void);

说实话，都差不多。我可能偏向于第一种，但这只是个人观点。